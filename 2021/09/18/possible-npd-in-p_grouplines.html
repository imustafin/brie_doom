<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width,initial-scale=1">

    <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Possible NPD with frontsector of line_t | Brie Doom</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Possible NPD with frontsector of line_t" />
<meta name="author" content="Ilgiz Mustafin" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Doom uses a structure called line to define the structure of the maps. It is assumed that each line always has a front sector and an optional back sector. If a line has only the front sector, then it is a one-sided line. If it has a back sector, then it is a two-sided line. Line structure is represented in the code with struct line_t:" />
<meta property="og:description" content="Doom uses a structure called line to define the structure of the maps. It is assumed that each line always has a front sector and an optional back sector. If a line has only the front sector, then it is a one-sided line. If it has a back sector, then it is a two-sided line. Line structure is represented in the code with struct line_t:" />
<link rel="canonical" href="https://briedoom.imustafin.tatar/2021/09/18/possible-npd-in-p_grouplines.html" />
<meta property="og:url" content="https://briedoom.imustafin.tatar/2021/09/18/possible-npd-in-p_grouplines.html" />
<meta property="og:site_name" content="Brie Doom" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-09-18T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Possible NPD with frontsector of line_t" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Ilgiz Mustafin","url":"https://imustafin.tatar"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://briedoom.imustafin.tatar/2021/09/18/possible-npd-in-p_grouplines.html"},"description":"Doom uses a structure called line to define the structure of the maps. It is assumed that each line always has a front sector and an optional back sector. If a line has only the front sector, then it is a one-sided line. If it has a back sector, then it is a two-sided line. Line structure is represented in the code with struct line_t:","url":"https://briedoom.imustafin.tatar/2021/09/18/possible-npd-in-p_grouplines.html","@type":"BlogPosting","headline":"Possible NPD with frontsector of line_t","dateModified":"2021-09-18T00:00:00+00:00","datePublished":"2021-09-18T00:00:00+00:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/tailwind.css">
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/syntax.css">

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
  </head>

  <body class="bg-california-50">
    <header class="px-4 lg:px-8 h-14 bg-california-500 flex flex-row items-center content-start mb-4">
      <span class="flex items-baseline">
        <a href="/" class="reset nounder font-bold flex-grow text-2xl">
          Brie Doom
        </a>
        <span class="hidden sm:inline-block text-xl">
          &nbsp;&mdash; a Doom source port in Eiffel
        </span>
      </span>
      <a
        href="https://github.com/imustafin/brie_doom"
        class="reset ml-auto flex items-center mr-4 font-bold">
        <span class="md:hidden">
          Sources
        </span>
        <span class="hidden md:inline-block">
          Source Code
        </span>
      </a>
      <a
        href="/documentation"
        class="reset flex items-center font-bold"
      >
        <span class="sm:hidden">
          Docs
        </span>
        <span class="hidden sm:inline-block">
          Documentation
        </span>
      </a>
    </header>

    <div class="container mx-auto px-2 sm:px-4 md:px-4">
      <article class="mx-auto">
  <h1 class="text-4xl font-bold text-center mb-4">
    <p>Possible NPD with frontsector of line_t</p>

  </h1>
  <div class="max-w-4xl mx-auto mb-8">
    <div>
      Published: 18 Sep 2021
    </div>
    <div>
      Tags: <a href="/tags/phase-1-bugs.html" rel="tag">phase-1-bugs</a>, <a href="/tags/bugs.html" rel="tag">bugs</a>, <a href="/tags/phase-1.html" rel="tag">phase-1</a>
    </div>
  </div>

  <div class="prose md:prose-xl max-w-4xl mx-auto">
    <p>Doom uses a structure called <em>line</em> to define the structure of the maps.
It is assumed that each line always has a front sector and an optional
back sector. If a line has only the front sector, then it is a one-sided line.
If it has a back sector, then it is a two-sided line. Line structure
is represented in the code with
<a href="https://github.com/id-Software/DOOM/blob/77735c3ff0772609e9c8d29e3ce2ab42ff54d20b/linuxdoom-1.10/r_defs.h#L179"><code class="language-plaintext highlighter-rouge">struct line_t</code></a>:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">line_s</span>
<span class="p">{</span>
  <span class="p">...</span>
  <span class="c1">// Front and back sector.</span>
  <span class="c1">// Note: redundant? Can be retrieved from SideDefs.</span>
  <span class="n">sector_t</span><span class="o">*</span>  <span class="n">frontsector</span><span class="p">;</span>
  <span class="n">sector_t</span><span class="o">*</span>  <span class="n">backsector</span><span class="p">;</span>
  <span class="p">...</span>
<span class="p">}</span> <span class="n">line_t</span><span class="p">;</span></code></pre></figure>

<p>In the code, dereferencing the <code class="language-plaintext highlighter-rouge">backsector</code> is usually preceded by a check
that <code class="language-plaintext highlighter-rouge">backsector</code> is not a null pointer. There are no such checks for
the <code class="language-plaintext highlighter-rouge">frontsector</code>. For example, this is illustrated in
<a href="https://github.com/id-Software/DOOM/blob/77735c3ff0772609e9c8d29e3ce2ab42ff54d20b/linuxdoom-1.10/p_setup.c#L523"><code class="language-plaintext highlighter-rouge">P_GroupLines</code></a>:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// count number of lines in each sector</span>
<span class="n">li</span> <span class="o">=</span> <span class="n">lines</span><span class="p">;</span>
<span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">numlines</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">li</span><span class="o">++</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">total</span><span class="o">++</span><span class="p">;</span>
  <span class="n">li</span><span class="o">-&gt;</span><span class="n">frontsector</span><span class="o">-&gt;</span><span class="n">linecount</span><span class="o">++</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">li</span><span class="o">-&gt;</span><span class="n">backsector</span> <span class="o">&amp;&amp;</span> <span class="n">li</span><span class="o">-&gt;</span><span class="n">backsector</span> <span class="o">!=</span> <span class="n">li</span><span class="o">-&gt;</span><span class="n">frontsector</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">li</span><span class="o">-&gt;</span><span class="n">backsector</span><span class="o">-&gt;</span><span class="n">linecount</span><span class="o">++</span><span class="p">;</span>
    <span class="n">total</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>However, when initializing line definitions, <code class="language-plaintext highlighter-rouge">frontsector</code> can be assigned
a null pointer in
<a href="https://github.com/id-Software/DOOM/blob/77735c3ff0772609e9c8d29e3ce2ab42ff54d20b/linuxdoom-1.10/p_setup.c#L423"><code class="language-plaintext highlighter-rouge">P_LoadLineDefs</code></a>:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">ld</span><span class="o">-&gt;</span><span class="n">sidenum</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SHORT</span><span class="p">(</span><span class="n">mld</span><span class="o">-&gt;</span><span class="n">sidenum</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="n">ld</span><span class="o">-&gt;</span><span class="n">sidenum</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SHORT</span><span class="p">(</span><span class="n">mld</span><span class="o">-&gt;</span><span class="n">sidenum</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">ld</span><span class="o">-&gt;</span><span class="n">sidenum</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">ld</span><span class="o">-&gt;</span><span class="n">frontsector</span> <span class="o">=</span> <span class="n">sides</span><span class="p">[</span><span class="n">ld</span><span class="o">-&gt;</span><span class="n">sidenum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">sector</span><span class="p">;</span>
<span class="k">else</span>
  <span class="n">ld</span><span class="o">-&gt;</span><span class="n">frontsector</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="n">ld</span><span class="o">-&gt;</span><span class="n">sidenum</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">ld</span><span class="o">-&gt;</span><span class="n">backsector</span> <span class="o">=</span> <span class="n">sides</span><span class="p">[</span><span class="n">ld</span><span class="o">-&gt;</span><span class="n">sidenum</span><span class="p">[</span><span class="mi">1</span><span class="p">]].</span><span class="n">sector</span><span class="p">;</span>
<span class="k">else</span>
  <span class="n">ld</span><span class="o">-&gt;</span><span class="n">backsector</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></code></pre></figure>

<p>Here, <code class="language-plaintext highlighter-rouge">mld</code> is the raw data read from the file and <code class="language-plaintext highlighter-rouge">ld</code> is the <code class="language-plaintext highlighter-rouge">line_t</code> being
constructed. When <code class="language-plaintext highlighter-rouge">sidenum[0]</code> is <code class="language-plaintext highlighter-rouge">-1</code>, null pointer is written to
<code class="language-plaintext highlighter-rouge">ld.frontsector</code>.</p>

<h2 id="solutions-in-existing-projects">Solutions in existing projects</h2>
<p>Other source ports handle this situation differently. For example,
Mocha Doom issues a warning in
<a href="https://github.com/AXDOOMER/mochadoom/blob/a1c6b24747ed21d3912608c9f6dc712dc57ce9c9/src/p/BoomLevelLoader.java#L1029">one case</a>:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="cm">/*
  * cph 2006/09/30 - our frontsector can be the second side of the
  * linedef, so must check for NO_INDEX in case we are incorrectly
  * referencing the back of a 1S line
  */</span>
<span class="k">if</span> <span class="o">(</span><span class="n">ldef</span><span class="o">.</span><span class="na">sidenum</span><span class="o">[</span><span class="n">side</span><span class="o">]</span> <span class="o">!=</span> <span class="no">NO_INDEX</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">li</span><span class="o">.</span><span class="na">frontsector</span> <span class="o">=</span> <span class="n">sides</span><span class="o">[</span><span class="n">ldef</span><span class="o">.</span><span class="na">sidenum</span><span class="o">[</span><span class="n">side</span><span class="o">]].</span><span class="na">sector</span><span class="o">;</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
  <span class="n">li</span><span class="o">.</span><span class="na">frontsector</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
  <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"P_LoadZSegs: front of seg %i has no sidedef\n"</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p>In the
<a href="https://github.com/AXDOOMER/mochadoom/blob/a1c6b24747ed21d3912608c9f6dc712dc57ce9c9/src/p/LevelLoader.java#L393">other case</a>
it sets <code class="language-plaintext highlighter-rouge">null</code> as the <code class="language-plaintext highlighter-rouge">frontsector</code> value:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// Front side defined without a valid frontsector.</span>
<span class="k">if</span> <span class="o">(</span><span class="n">ld</span><span class="o">.</span><span class="na">sidenum</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">!=</span> <span class="n">line_t</span><span class="o">.</span><span class="na">NO_INDEX</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">ld</span><span class="o">.</span><span class="na">frontsector</span> <span class="o">=</span> <span class="n">sides</span><span class="o">[</span><span class="n">ld</span><span class="o">.</span><span class="na">sidenum</span><span class="o">[</span><span class="mi">0</span><span class="o">]].</span><span class="na">sector</span><span class="o">;</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">ld</span><span class="o">.</span><span class="na">frontsector</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// // Still null? Bad map. Map to dummy.</span>
    <span class="n">ld</span><span class="o">.</span><span class="na">frontsector</span> <span class="o">=</span> <span class="n">dummy_sector</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
  <span class="n">ld</span><span class="o">.</span><span class="na">frontsector</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<p><a href="https://github.com/jval1972/DelphiDoom/blob/5bf3eedfec9af85decdaac3a6bba675a6de0fc82/Doom/p_setup.pas#L1037">Delphi Doom</a>
also issues a warning and sets another sector as the <code class="language-plaintext highlighter-rouge">frontsector</code>:</p>

<figure class="highlight"><pre><code class="language-pascal" data-lang="pascal"><span class="k">if</span> <span class="p">(</span><span class="n">ld</span><span class="p">.</span><span class="n">sidenum</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">&gt;=</span> <span class="m">0</span><span class="p">)</span> <span class="k">and</span> <span class="p">(</span><span class="n">ld</span><span class="p">.</span><span class="n">sidenum</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">&lt;</span> <span class="n">numsides</span><span class="p">)</span> <span class="k">then</span>
  <span class="n">ld</span><span class="p">.</span><span class="n">frontsector</span> <span class="p">:=</span> <span class="n">sides</span><span class="p">[</span><span class="n">ld</span><span class="p">.</span><span class="n">sidenum</span><span class="p">[</span><span class="m">0</span><span class="p">]].</span><span class="n">sector</span>
<span class="k">else</span>
<span class="k">begin</span>
  <span class="k">if</span> <span class="n">devparm</span> <span class="k">then</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">'P_LoadLineDefs(): Line %d does has invalid front sidedef %d'</span><span class="p">#</span><span class="m">13</span><span class="p">#</span><span class="m">10</span><span class="p">,</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ld</span><span class="p">.</span><span class="n">sidenum</span><span class="p">[</span><span class="m">0</span><span class="p">]]);</span>
  <span class="n">ld</span><span class="p">.</span><span class="n">sidenum</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">:=</span> <span class="m">0</span><span class="p">;</span>
  <span class="n">ld</span><span class="p">.</span><span class="n">frontsector</span> <span class="p">:=</span> <span class="n">sides</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">sector</span><span class="p">;</span>
<span class="k">end</span><span class="p">;</span></code></pre></figure>

<h2 id="our-solution-and-void-safety">Our solution and Void Safety</h2>
<p>Brie Doomâ€™s source code is written with Void Safety enabled, so we have to
decide if <code class="language-plaintext highlighter-rouge">frontsector</code> should indeed be <code class="language-plaintext highlighter-rouge">attached</code> and assigning <code class="language-plaintext highlighter-rouge">Void</code> to
it should be banned, or should it be <code class="language-plaintext highlighter-rouge">detached</code> and all dereferences will
be preceded with checking if <code class="language-plaintext highlighter-rouge">frontsector</code> is not <code class="language-plaintext highlighter-rouge">Void</code>. We cannot simply
ignore this problem by assigning <code class="language-plaintext highlighter-rouge">Void</code> in one place and just assuming
that it should not be <code class="language-plaintext highlighter-rouge">Void</code> in other places.</p>

<p>As a temporary solution for phase 1 we decided to leave
<code class="language-plaintext highlighter-rouge">frontsector</code> as <code class="language-plaintext highlighter-rouge">detached</code> to preserve
the original behaviour. All dereferences of <code class="language-plaintext highlighter-rouge">frontsector</code> first check
that it is not <code class="language-plaintext highlighter-rouge">Void</code>. Example in
<a href="https://github.com/imustafin/brie_doom/blob/50f595c05fbbe59509f158bcea390bc908a500e7/brie_doom/p_setup.e"><code class="language-plaintext highlighter-rouge">P_GroupLines</code></a>:</p>

<figure class="highlight"><pre><code class="language-eiffel" data-lang="eiffel"><span class="c1">-- count number of lines in each sector</span>
<span class="n">total</span> <span class="pi">:=</span> <span class="mi">0</span>
<span class="k">from</span>
  <span class="n">i</span> <span class="pi">:=</span> <span class="mi">0</span>
<span class="k">until</span>
  <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">numlines</span>
<span class="k">loop</span>
  <span class="n">total</span> <span class="pi">:=</span> <span class="n">total</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="k">check</span> <span class="k">attached</span> <span class="n">lines</span> <span class="pi">[</span><span class="n">i</span><span class="pi">].</span><span class="n">frontsector</span> <span class="k">as</span> <span class="n">frontsector</span> <span class="k">then</span>
    <span class="n">frontsector</span><span class="pi">.</span><span class="n">linecount</span> <span class="pi">:=</span> <span class="n">frontsector</span><span class="pi">.</span><span class="n">linecount</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="k">end</span>
  <span class="k">if</span> <span class="k">attached</span> <span class="n">lines</span> <span class="pi">[</span><span class="n">i</span><span class="pi">].</span><span class="n">backsector</span> <span class="k">as</span> <span class="n">bs</span> <span class="k">and</span> <span class="k">then</span> <span class="n">bs</span> <span class="o">/=</span> <span class="n">lines</span> <span class="pi">[</span><span class="n">i</span><span class="pi">].</span><span class="n">frontsector</span> <span class="k">then</span>
    <span class="n">bs</span><span class="pi">.</span><span class="n">linecount</span> <span class="pi">:=</span> <span class="n">bs</span><span class="pi">.</span><span class="n">linecount</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="k">end</span>
  <span class="n">i</span> <span class="pi">:=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
<span class="k">end</span></code></pre></figure>

<p>This solution is not ideal as it increases the verbosity of the code.
Each access to <code class="language-plaintext highlighter-rouge">frontsector</code> has to be surrounded by a <code class="language-plaintext highlighter-rouge">check</code>.</p>

<p>In fact, this solution does not solve the real problem. What should the game
do with a malformed map data? Maybe it should refuse working with such incorrect
data altogether, maybe not. Changing this behaviour is left for phase 2
where we will revisit this problem again.</p>

  </div>
</article>



      <footer class="px-4 flex flex-col items-center text-center pb-2">
        <hr class="border border-california-400 w-11/12 mb-4 mt-8">
        <p class="mb-2">
          Brie Doom is written by <a href="https://imustafin.tatar">Ilgiz Mustafin</a>
        </p>
        <p class="mb-2">
          Source code is <a href="https://github.com/imustafin/brie_doom">available on GitHub</a>
        </p>
        <p>
          Parts of the program are based on <a href="https://www.chocolate-doom.org/">Chocolate&nbsp;Doom</a>
          and <a href="http://mochadoom.sourceforge.net/">Mocha&nbsp;Doom</a>
        </p>
      </footer>
    </div>
  </body>
</html>
